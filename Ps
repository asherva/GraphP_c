param(
    [string[]]$RemoteComputers = @("Server1","Server2"),
    [string]$RemoteLogFolder = "C:\ProgramData\Tableau\Tableau Server\data\tabsvc\logs\hyper",
    [string]$OutputLogFile = "C:\Temp\HyperPortConflicts_AllServers.csv"
)

# ××©×ª× ×” ×’×œ×•×‘×œ×™ ×œ×©××™×¨×ª ×›×œ ×”×”×ª× ×’×©×•×™×•×ª ×‘××›×•× ×” ×”××§×•××™×ª
$Global:PortConflicts = @()

# ×¤×•× ×§×¦×™×” ×œ×§×‘×œ×ª ×”×§×•×‘×¥ ×”××—×¨×•×Ÿ ×©×œ Hyper ××”×™×•× ×‘×©×¨×ª ××¨×•×—×§
function Get-RemoteLatestLog {
    param($Computer, $Folder)
    try {
        $session = New-PSSession -ComputerName $Computer -ErrorAction Stop
    } catch {
        Write-Host "âŒ ×œ× × ×™×ª×Ÿ ×œ×™×¦×•×¨ ×¡×©×Ÿ ×œ×©×¨×ª $($Computer): $($_.Exception.Message)" -ForegroundColor Red
        return $null
    }

    try {
        $logPath = Invoke-Command -Session $session -ScriptBlock {
            param($FolderRemote)
            $today = (Get-Date).Date
            $log = Get-ChildItem -Path $FolderRemote -Filter "hyper_0_????_??_??_??_??_??.txt" -ErrorAction SilentlyContinue |
                   Where-Object { $_.LastWriteTime.Date -eq $today } |
                   Sort-Object LastWriteTime -Descending |
                   Select-Object -First 1
            if ($log) { return $log.FullName } else { return $null }
        } -ArgumentList $Folder
    } catch {
        Write-Host "âŒ ×©×’×™××” ×‘×§×¨×™××ª ×§×‘×¦×™× ×‘×©×¨×ª $($Computer): $($_.Exception.Message)" -ForegroundColor Red
        Remove-PSSession $session
        return $null
    }

    Remove-PSSession $session
    return $logPath
}

# ×¤×•× ×§×¦×™×” ×œ× ×™×˜×•×¨ Hyper ×¢×œ ×©×¨×ª ××¨×•×—×§
function Monitor-HyperRemote {
    param($Computer, $LogPath, $OutputFile)

    if (-not $LogPath) {
        Write-Host "âŒ ×œ× × ××¦× ×§×•×‘×¥ Hyper ××”×™×•× ×¢×œ $($Computer)"
        return
    }

    $logFileName = Split-Path $LogPath -Leaf
    Write-Host "ğŸŸ¢ ××ª×—×™×œ × ×™×˜×•×¨ Hyper ×‘×–××Ÿ ×××ª ×¢×œ $($Computer): $logFileName ..."

    # ×”×¤×¢×œ×” ×‘××§×‘×™×œ ×¢× Start-Job
    Start-Job -Name "Monitor_$Computer" -ScriptBlock {
        param($ServerName, $LogPath, $OutputFile)

        try {
            $session = New-PSSession -ComputerName $ServerName -ErrorAction Stop
        } catch {
            Write-Host "âŒ ×œ× × ×™×ª×Ÿ ×œ×™×¦×•×¨ ×¡×©×Ÿ ×‘×ª×•×š Job ×œ×©×¨×ª $($ServerName): $($_.Exception.Message)" -ForegroundColor Red
            return
        }

        Invoke-Command -Session $session -ScriptBlock {
            param($FullPath)
            $fsw = New-Object System.IO.FileSystemWatcher
            $fsw.Path = Split-Path $FullPath
            $fsw.Filter = Split-Path $FullPath -Leaf
            $fsw.EnableRaisingEvents = $true
            $fsw.NotifyFilter = [System.IO.NotifyFilters]'LastWrite'

            Register-ObjectEvent $fsw Changed -Action {
                $lines = Get-Content $FullPath -Tail 5
                foreach ($line in $lines) {
                    if ($line -match "Address already in use") {
                        $time = (Get-Date).ToString("yyyy-MM-dd HH:mm:ss")
                        Write-Output "$time|$env:COMPUTERNAME|$line"
                    }
                }
            }

            while ($true) { Start-Sleep 1 }
        } -ArgumentList $LogPath | ForEach-Object {
            $parts = $_ -split "\|"
            $obj = [PSCustomObject]@{
                Time    = $parts[0]
                Server  = $parts[1]
                LogLine = $parts[2]
            }

            # ×©××™×¨×” ×œ-CSV ××”××›×•× ×” ×”××§×•××™×ª
            $obj | Export-Csv -Path $OutputFile -NoTypeInformation -Append
            # ×©××™×¨×” ×‘×¤×¨××˜×¨ ×¤× ×™××™
            $Global:PortConflicts += $obj
            Write-Host "$($obj.Time) âš  Address already in use on $($obj.Server): $($obj.LogLine)" -ForegroundColor Red
        }

        Remove-PSSession $session
    } -ArgumentList $Computer, $LogPath, $OutputFile
}

# --- ×”×¤×¢×œ×” ×œ×›×œ ×”×©×¨×ª×™× ---
foreach ($server in $RemoteComputers) {
    $LatestLog = Get-RemoteLatestLog -Computer $server -Folder $RemoteLogFolder
    Monitor-HyperRemote -Computer $server -LogPath $LatestLog -OutputFile $OutputLogFile
}

Write-Host "ğŸŸ¢ × ×™×˜×•×¨ ×”×ª×—×™×œ ×œ×›×œ ×”×©×¨×ª×™×. ×‘×“×•×§ ××ª ×”×§×•×‘×¥ $OutputLogFile ×œ×”×ª×¨××•×ª."
