param(
    [string]$LogPath = "C:\ProgramData\Tableau\Tableau Server\data\tabsvc\logs\hyper\hyperd.log"
)

# ×§×™×“×•×“ ×œ××¡×•×£ ×‘×¢×‘×¨×™×ª
chcp 65001
$OutputEncoding = [System.Text.Encoding]::UTF8

# ×¤×¨××˜×¨×™× ×’×œ×•×‘×œ×™×™×
$Global:PortConflicts = @()

# ×¤×•× ×§×¦×™×” ×œ××¢×§×‘ ××—×¨ ×©×’×™××•×ª Address already in use
function Monitor-HyperPortConflicts {
    param([string]$LogFile)

    if (-Not (Test-Path $LogFile)) {
        Write-Host "âŒ ×§×•×‘×¥ ×œ×•×’ Hyper ×œ× × ××¦×: $LogFile"
        return
    }

    Write-Host "ğŸŸ¢ ××ª×—×™×œ × ×™×˜×•×¨ Hyper ×¢×œ ×©×’×™××•×ª 'Address already in use'..."

    Get-Content $LogFile -Wait | ForEach-Object {
        $line = $_
        if ($line -match "Address already in use") {
            $time = (Get-Date).ToString("yyyy-MM-dd HH:mm:ss")

            # ×œ× ×¡×•×ª ×œ×—×œ×¥ PID ×•×©× Extract ×× ××•×¤×™×¢ ×‘-CommandLine
            $hyperProcesses = Get-CimInstance Win32_Process | Where-Object { $_.Name -like "hyperd*" }
            $extractName = "×œ× ×–×•×”×”"
            $pid = $null

            foreach ($proc in $hyperProcesses) {
                if ($proc.CommandLine -match "\S+\.hyper") {
                    $extractName = $matches[0]
                    $pid = $proc.ProcessId
                    break
                }
            }

            $msg = "$time âš  ×¤×•×¨×˜ ×ª×¤×•×¡ ×‘×–××Ÿ ×××ª! PID: $pid, Extract: $extractName"
            Write-Host $msg -ForegroundColor Red
            $Global:PortConflicts += [PSCustomObject]@{
                Time    = $time
                PID     = $pid
                Extract = $extractName
                LogLine = $line
            }
        }
    }
}

# --- ×”×¤×¢×œ×” ---
Monitor-HyperPortConflicts -LogFile $LogPath
