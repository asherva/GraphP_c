××” ×”×¡×§×¨×™×¤×˜ ×¢×•×©×”

××ª×—×‘×¨ ×œ×›×œ ×©×¨×ª ×‘×¨×©×™××ª $RemoteComputers ×‘×××¦×¢×•×ª PowerShell Remoting

××•×¦× ××ª ×§×•×‘×¥ ×”×œ×•×’ ×”××—×¨×•×Ÿ ×©×œ Hyper ×‘×›×œ ×©×¨×ª

×™×•×¦×¨ FileSystemWatcher ×œ×›×œ ×§×•×‘×¥ â€“ ×ª×’×•×‘×” ×›××¢×˜ ××™×™×“×™×ª ×œ×©×•×¨×” ×—×“×©×”

×›×œ ×¤×¢× ×©××•×¤×™×¢×” ×”×©×’×™××” "Address already in use":

××¦×™×’ ×”×•×“×¢×” ×‘×–××Ÿ ×××ª ×œ××¡×•×£ ×¢× ×©× ×”×©×¨×ª

×›×•×ª×‘ ×œÖ¾CSV ××¨×›×–×™ ($OutputLogFile)

×©×•××¨ ×‘×¤×¨××˜×¨ ×¤× ×™××™ $Global:PortConflicts

×¨×¥ ×‘×¨×¦×£ ×¢×“ ×¢×¦×™×¨×” ×™×“× ×™×ª (Ctrl+C)

×™×ª×¨×•× ×•×ª

×××¤×©×¨ × ×™×˜×•×¨ ××¨×•×›×– ×©×œ ××¡×¤×¨ ×©×¨×ª×™×

×ª×’×•×‘×” ××”×™×¨×” ×›××¢×˜ ×‘×–××Ÿ ×××ª ×œ×©×’×™××•×ª

×ª×™×¢×•×“ ××œ× ×œ×©×™××•×© ×œ× ×™×ª×•×—×™× ×××•×—×¨×™×

××™×Ÿ ×¤×’×™×¢×” ×‘×‘×™×¦×•×¢×™ ×”×©×¨×ª×™× â€“ ×§×•×¨× ×¨×§ ×©×•×¨×•×ª ×—×“×©×•×ª

× ×™×ª×Ÿ ×œ×”×•×¡×™×£ ×”×ª×¨××” (××™×™×œ/×˜×œ×’×¨×) ×‘×§×œ×•×ª ×‘×¤×•× ×§×¦×™×” -Action ×©×œ FileSystemWatcher



param(
    [string[]]$RemoteComputers = @("Server1","Server2"),  # ×¨×©×™××ª ×©×¨×ª×™× ××¨×•×—×§×™×
    [string]$RemoteLogFolder = "C$\ProgramData\Tableau\Tableau Server\data\tabsvc\logs\hyper",
    [string]$OutputLogFile = "C:\Temp\HyperPortConflicts_AllServers.csv"
)

# ××©×ª× ×” ×’×œ×•×‘×œ×™ ×œ×©××™×¨×ª ×›×œ ×”×”×ª× ×’×©×•×™×•×ª
$Global:PortConflicts = @()

# ×¤×•× ×§×¦×™×” ×œ×§×‘×œ×ª ×”×§×•×‘×¥ ×”××—×¨×•×Ÿ ×‘×©×¨×ª ××¨×•×—×§
function Get-RemoteLatestLog {
    param($Computer, $Folder)
    $session = New-PSSession -ComputerName $Computer
    $log = Invoke-Command -Session $session -ScriptBlock {
        param($FolderRemote)
        Get-ChildItem -LiteralPath $FolderRemote -Filter "hyper_0_*.txt" |
        Sort-Object LastWriteTime -Descending |
        Select-Object -First 1
    } -ArgumentList $Folder
    Remove-PSSession $session
    return $log
}

# ×¤×•× ×§×¦×™×” ×œ× ×™×˜×•×¨ Hyper ×¢×œ ×©×¨×ª ××¨×•×—×§
function Monitor-HyperRemote {
    param($Computer, $LogPath, $OutputFile)
    
    Write-Host "ğŸŸ¢ × ×™×˜×•×¨ Hyper ×‘×–××Ÿ ×××ª ×¢×œ $Computer: $($LogPath.Name)..."

    $session = New-PSSession -ComputerName $Computer
    Invoke-Command -Session $session -ScriptBlock {
        param($FullPath, $OutputFile)
        
        $fsw = New-Object System.IO.FileSystemWatcher
        $fsw.Path = Split-Path $FullPath
        $fsw.Filter = Split-Path $FullPath -Leaf
        $fsw.EnableRaisingEvents = $true
        $fsw.NotifyFilter = [System.IO.NotifyFilters]'LastWrite'

        Register-ObjectEvent $fsw Changed -Action {
            $lines = Get-Content $FullPath -Tail 5
            foreach ($line in $lines) {
                if ($line -match "Address already in use") {
                    $time = (Get-Date).ToString("yyyy-MM-dd HH:mm:ss")
                    $obj = [PSCustomObject]@{
                        Time    = $time
                        Server  = $env:COMPUTERNAME
                        LogLine = $line
                    }

                    # ×©××™×¨×” ×œ×§×•×‘×¥ CSV ××¨×›×–×™
                    $obj | Export-Csv -Path $OutputFile -NoTypeInformation -Append

                    # ×©××™×¨×” ×‘×¤×¨××˜×¨ ×¤× ×™××™
                    $Global:PortConflicts += $obj

                    Write-Host "$time âš  Address already in use on $($env:COMPUTERNAME): $line" -ForegroundColor Red
                }
            }
        }

        Write-Host "ğŸŸ¢ ×××ª×™×Ÿ ×œ××™×¨×•×¢×™×... (Ctrl+C ×œ×¢×¦×™×¨×”)"
        while ($true) { Start-Sleep 1 }
    } -ArgumentList $LogPath.FullName, $OutputFile
}

# --- ×”×¤×¢×œ×” ×¢×‘×•×¨ ×›×œ ×©×¨×ª ×‘×¨×©×™××” ---
foreach ($server in $RemoteComputers) {
    $LatestLog = Get-RemoteLatestLog -Computer $server -Folder $RemoteLogFolder
    if ($LatestLog) {
        Monitor-HyperRemote -Computer $server -LogPath $LatestLog -OutputFile $OutputLogFile
    } else {
        Write-Host "âŒ ×œ× × ××¦× ×§×•×‘×¥ ×œ×•×’ Hyper ×‘×©×¨×ª $server"
    }
}
